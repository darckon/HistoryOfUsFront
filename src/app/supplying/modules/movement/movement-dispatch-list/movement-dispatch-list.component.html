<button *ngIf="createPrevilege" routerLink="/supplying/movements/create" mat-button color="primary"
  style="float:right;">
  <mat-icon>add</mat-icon>Generar movimiento
</button>


<form [formGroup]="filterGroup" fxLayoutAlign="start" fxLayoutGap="15px"
  style="flex-wrap:wrap;margin-bottom: 15px;width: 100%;">

  <mat-expansion-panel style="flex-basis: 100%; flex-grow: 1;">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <b>Filtros</b>
      </mat-panel-title>
    </mat-expansion-panel-header>

    <span style="flex-basis: 100%; flex-grow: 1;">


      <span fxLayoutAlign="start" style="flex-wrap:wrap;">

        <mat-form-field appearance="outline" style="margin:5px;flex-grow: 1;" class="mobile-form-input">
          <input matInput [matDatepicker]="picker" placeholder="Fecha de inicio" formControlName='initDateInput'>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="filterGroup.controls['initDateInput'].hasError('required')">
            Este campo es <strong>obligatorio</strong>
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" style="margin:5px; flex-grow: 1;" class="mobile-form-input">
          <input matInput [matDatepicker]="picker2" placeholder="Fecha de término" formControlName='endDateInput'>
          <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
          <mat-datepicker #picker2></mat-datepicker>
          <mat-error *ngIf="filterGroup.controls['endDateInput'].hasError('required')">
            Este campo es <strong>obligatorio</strong>
          </mat-error>
        </mat-form-field>


      </span>

      <span fxLayoutAlign="start" style="flex-wrap:wrap;">
        <mat-form-field appearance="outline" style="margin:5px; flex-grow: 1;" class="mobile-form-input">

          <mat-label>Origen (*)</mat-label>
          <mat-select *ngIf="!filterGroup.value.origin" formControlName="origin">
            <mat-option *ngFor="let loc of locations" [value]="loc">
              {{loc.name}}
            </mat-option>
          </mat-select>
          <mat-chip-list *ngIf="filterGroup.value?.origin" style="height: 10px;width:100%;">
            <mat-chip selected style="height: 10px;width:100%;" removable>
              {{filterGroup.value.origin.name}}
              <mat-icon matChipRemove (click)="removeFilter(filterGroup.get('origin'))">cancel</mat-icon>
            </mat-chip>
          </mat-chip-list>

          <mat-error *ngIf="filterGroup.controls['origin'].hasError('required')">
            Este campo es <strong>obligatorio</strong>
          </mat-error>

        </mat-form-field>
        <mat-form-field appearance="outline" style="margin:5px;flex-grow: 1;" class="mobile-form-input">
          <mat-label>Tipo de movimiento(*) </mat-label>
          <mat-select *ngIf="!filterGroup.value.movementType" formControlName="movementType">
            <mat-option *ngFor="let mt of movementType" [value]="mt">
              {{mt.name}}
            </mat-option>
          </mat-select>
          <mat-chip-list *ngIf="filterGroup.value?.movementType" style="height: 10px;width:100%;">
            <mat-chip selected style="height: 10px;width:100%;" removable>
              {{filterGroup.value.movementType.name}}
              <mat-icon matChipRemove (click)="removeFilter(filterGroup.get('movementType'))">cancel</mat-icon>
            </mat-chip>
          </mat-chip-list>
          <mat-error *ngIf="filterGroup.controls['movementType'].hasError('required')">
            Este campo es <strong>obligatorio</strong>
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" style="margin:5px; flex-grow: 1;" class="mobile-form-input">
          <input matInput placeholder="Código pedido" formControlName='orderCodeInput'>
        </mat-form-field>

      </span>

      <span fxLayoutAlign="start" style="flex-wrap:wrap;">
        <button [disabled]="!filterGroup.valid" style="height: 40px; width:100%; flex-basis: 10%; flex-grow: 1; "
          (click)="sendForm()" mat-raised-button color="primary">
          <mat-icon>search</mat-icon> Filtrar
        </button>
      </span>



    </span>

  </mat-expansion-panel>

</form>

<mat-tab-group [animationDuration]="0" [selectedIndex]="currentTab" (selectedTabChange)="tabChanged($event)">
  <mat-tab [disabled]="!filterGroup.valid" style="margin:15px;">
    <ng-template mat-tab-label>
      {{ 'SUPPLYING.ORDER._REQUESTED_' | translate }}
    </ng-template>
  </mat-tab>
  <mat-tab style="margin:15px;" [disabled]="!filterGroup.valid">
    <ng-template mat-tab-label>
      {{ 'SUPPLYING.ORDER._TRANSIT_' | translate }}
    </ng-template>
  </mat-tab>
  <mat-tab style="margin:15px;" [disabled]="!filterGroup.valid">
    <ng-template mat-tab-label>
      {{ 'SUPPLYING.ORDER._FINISHED_' | translate }}
    </ng-template>
  </mat-tab>
</mat-tab-group> 
<div *ngIf="noData == true">
  <h3>No hay datos que mostrar</h3>
</div>
<div *ngIf="noData == false">
    <div *ngIf="isLoadingData" style="min-height: 400px;">
      <mat-spinner style="margin:0 auto;" mode="indeterminate"></mat-spinner>
    </div>

    <div *ngIf="!isLoadingData" style="min-height: 400px;margin: 15px;margin-top: 30px;">
      <mat-table [class.isMobile]="isMobile" [dataSource]="dataSource">

        <ng-container cdkColumnDef="n_order">
          <mat-header-cell md-sort-header *cdkHeaderCellDef>N° Pedido</mat-header-cell>
          <mat-cell *cdkCellDef="let element">
            <p class="table-data" style="width: 90%;">
              <span class="mobile-label blue">N° Pedido:</span>
              <app-order-info [AllowDispatch]="true" [order]="element.correlative" [id]="element.id"  [detailRoute]="'dispatches'" ></app-order-info>
            </p>
          </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="comment">
          <mat-header-cell md-sort-header *cdkHeaderCellDef>Comentario</mat-header-cell>
          <mat-cell *cdkCellDef="let element">
            <p class="table-data">
              <span class="mobile-label blue">Comentario:</span>
              {{element.comment}}
            </p>
          </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="type">
          <mat-header-cell md-sort-header *cdkHeaderCellDef>Tipo movimiento</mat-header-cell>
          <mat-cell *cdkCellDef="let element">
            <p class="table-data">
              <span class="mobile-label blue">Tipo:</span>
              {{element.movement_type.name }}
            </p>
          </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="status">
          <mat-header-cell md-sort-header *cdkHeaderCellDef>Estado movimiento</mat-header-cell>
          <mat-cell *cdkCellDef="let element">
            <p class="table-data">
              <span class="mobile-label blue">Estado movimiento:</span>
              {{element.movement_state.name }}
            </p>
          </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="origin_name">
          <mat-header-cell md-sort-header *cdkHeaderCellDef>Origen</mat-header-cell>
          <mat-cell *cdkCellDef="let element">
            <p class="table-data">
              <span class="mobile-label blue">Origen:</span>
              {{element.origin_name }}
            </p>
          </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="destination_name">
          <mat-header-cell md-sort-header *cdkHeaderCellDef>Destino</mat-header-cell>
          <mat-cell *cdkCellDef="let element">
            <p class="table-data">
              <span class="mobile-label blue">Destino:</span>
              {{element.destination_name }}
            </p>
          </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="created_at">
          <mat-header-cell md-sort-header *cdkHeaderCellDef>Creado</mat-header-cell>
          <mat-cell *cdkCellDef="let element">
            <p class="table-data">
              <span class="mobile-label blue">Solicitado:</span>
              {{element.created_at | date:'shortDate' }}
            </p>
          </mat-cell>
        </ng-container>

        <ng-container cdkColumnDef="actions">
          <mat-header-cell md-sort-header *cdkHeaderCellDef> </mat-header-cell>
          <mat-cell *cdkCellDef="let element">
            <span class="mobile-label blue"><b>Opciones:</b></span>
            <button *ngIf="priv_canDispatch" class="mat-button-action" mat-button color="primary" matTooltip="Despachar"
              routerLink="/supplying/dispatches/detail/{{element.id}}">
              <mat-icon>assignment</mat-icon>
            </button>
            <button *ngIf="priv_canConsilidate" class="mat-button-action" mat-button color="accent" (click)="addToList(element)"
              matTooltip="Añadir a consolidado">
              <mat-icon>add</mat-icon>
            </button>

          </mat-cell>
        </ng-container>

        <mat-header-row *cdkHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *cdkRowDef="let row; columns: displayedColumns;"></mat-row>
      </mat-table>

      <h3 *ngIf="this.results?.length == 0">No hay datos que mostrar</h3>

    </div>
  </div>
    <mat-paginator style="margin-bottom: 80px;" [length]="pageNumber" [hidePageSize]="true" [pageSizeOptions]="[10]"
      (page)="pageEvent = loadPageData($event)" showFirstLastButtons></mat-paginator>

    <div class="floating">

      <mat-card [hidden]="consolidatedList?.length==0" class="floating-card">
        <div class="floating-card-content">
          <span style="width: 80% !important; padding-right: 10px; display: flex; flex-direction: row;">

            <div class="md-chips">
              <div class="md-chip" style="max-width: 100px;" *ngFor="let element of consolidatedList"
                matTooltip="{{element.comment}} - {{element.movement_type.name}}">
                <div class="md-chip-icon">
                  <mat-icon [inline]="true">subject</mat-icon>
                </div>
                <span>{{element.correlative}}</span>
                <button type="button" (click)="removeFromList(element);" class="md-chip-remove">
                </button>
              </div>
            </div>

          </span>
          <span style="align-self:flex-end;flex-grow: 2;">
            <div style="display: flex;flex-direction:column;margin: 5px;">
              <button mat-stroked-button color="accent" style="width: 100%;height: 30px;margin: 2px;"
                (click)="consolidated()" mat-raised-button> Ver consolidado</button>
              <button mat-stroked-button color="primary" style="width: 100%;height: 30px;margin: 2px;"
                (click)="clearConsolidated()" mat-raised-button> Cancelar</button>
            </div>

          </span>

        </div>
      </mat-card>


    </div>